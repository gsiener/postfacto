# OpenTelemetry Configuration for Postfacto
# ==========================================
# Copy these variables to your .env file for local development
# or add them to your Render.com environment variables for production

# Required: Enable OpenTelemetry instrumentation
# Set to 'true' to enable, 'false' to disable
OTEL_INSTRUMENTATION_ACTIVE=true

# Required: Honeycomb API endpoint
# Use the default Honeycomb OTLP endpoint
OTEL_EXPORTER_OTLP_ENDPOINT=https://api.honeycomb.io

# Required: Honeycomb API key
# Get your API key from https://ui.honeycomb.io/account
# SECURITY: Never commit this value to git
HONEYCOMB_API_KEY=YOUR_HONEYCOMB_API_KEY_HERE

# Required: Honeycomb dataset name
# This is where your traces will be sent
HONEYCOMB_DATASET=postfacto-production

# Optional: Service name (defaults to 'postfacto')
OTEL_SERVICE_NAME=postfacto

# Optional: Sampling configuration
# Use 'parentbased_traceidratio' for production (recommended)
# Other options: 'always_on', 'always_off', 'traceidratio'
OTEL_TRACES_SAMPLER=parentbased_traceidratio

# Optional: Sampling ratio (0.0 to 1.0)
# Production: Start with 0.1 (10% sampling) to control costs
# Development: Use 1.0 (100% sampling) for full visibility
OTEL_TRACES_SAMPLER_ARG=0.1

# Optional: Resource attributes
# These help identify your deployment in Honeycomb
OTEL_RESOURCE_ATTRIBUTES=deployment.environment=production,service.version=1.0.0

# Optional: Service version
SERVICE_VERSION=1.0.0

# ==========================================
# Configuration Guide
# ==========================================

# LOCAL DEVELOPMENT
# -----------------
# 1. Copy this file to api/.env
# 2. Set OTEL_INSTRUMENTATION_ACTIVE=true
# 3. Set OTEL_TRACES_SAMPLER_ARG=1.0 for full sampling
# 4. Add your Honeycomb API key
# 5. Set HONEYCOMB_DATASET=postfacto-development
# 6. Run: ./run.sh

# PRODUCTION (Render.com)
# -----------------------
# 1. Go to your Render.com dashboard
# 2. Navigate to your web service
# 3. Go to Environment tab
# 4. Add these environment variables:
#    - OTEL_INSTRUMENTATION_ACTIVE=true
#    - OTEL_EXPORTER_OTLP_ENDPOINT=https://api.honeycomb.io
#    - HONEYCOMB_API_KEY=<your-api-key>
#    - HONEYCOMB_DATASET=postfacto-production
#    - OTEL_TRACES_SAMPLER=parentbased_traceidratio
#    - OTEL_TRACES_SAMPLER_ARG=0.1
#    - OTEL_RESOURCE_ATTRIBUTES=deployment.environment=production,service.version=1.0.0
# 5. Deploy your application

# SAMPLING RECOMMENDATIONS
# ------------------------
# - Development: 1.0 (100%) - See all traces
# - Staging: 0.5 (50%) - Balance visibility and cost
# - Production (low traffic): 0.25 (25%) - Good visibility
# - Production (high traffic): 0.1 (10%) - Cost effective
# - Production (very high traffic): 0.05 (5%) - Minimal cost

# COST ESTIMATION
# ---------------
# With 10% sampling on a moderately active retro application:
# - ~100 requests/day
# - ~10 spans per request
# - 100 * 0.1 * 10 = 100 spans/day
# - ~3,000 spans/month (well within Honeycomb free tier)

# SECURITY NOTES
# --------------
# - SQL statements are automatically obfuscated (no passwords/tokens)
# - Authorization headers are excluded from HTTP spans
# - Never commit HONEYCOMB_API_KEY to git
# - Use Render.com environment variables for production secrets

# TROUBLESHOOTING
# ---------------
# - If traces aren't appearing in Honeycomb:
#   1. Check OTEL_INSTRUMENTATION_ACTIVE is set to 'true'
#   2. Verify HONEYCOMB_API_KEY is correct
#   3. Check application logs for "OpenTelemetry initialized" message
#   4. Verify sampling rate isn't too low (try 1.0 for testing)
#   5. Check Honeycomb dataset name matches your configuration

# MONITORING HONEYCOMB
# --------------------
# Once deployed, you can query traces in Honeycomb:
# - View all traces: Go to your dataset in Honeycomb UI
# - Find slow requests: WHERE duration_ms > 1000 GROUP BY http.route
# - Track broadcasts: WHERE name = "broadcast.retro_update" CALCULATE P95(broadcast.duration_ms)
# - Monitor errors: WHERE error = true GROUP BY exception.class
# - WebSocket health: WHERE messaging.operation = "subscribe" GROUP BY retro.id
